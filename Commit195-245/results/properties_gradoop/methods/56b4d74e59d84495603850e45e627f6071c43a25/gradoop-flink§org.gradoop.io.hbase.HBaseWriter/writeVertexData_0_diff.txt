/**                                                                                                    /**                                                                                                 
* Converts runtime vertex data to persistent vertex data (includes                                     * Converts runtime vertex data to persistent vertex data (includes                                  
* incoming and outgoing edge data) and writes it to HBase.                                             * incoming and outgoing edge data) and writes it to HBase.                                          
*                                                                                                      *                                                                                                   
* @param epgmDatabase                EPGM database instance                                            * @param epgmDatabase                EPGM database instance                                         
* @param vertexDataHandler           vertex data handler                                               * @param vertexDataHandler           vertex data handler                                            
* @param persistentVertexDataFactory persistent vertex data factory                                    * @param persistentVertexDataFactory persistent vertex data factory                                 
* @param vertexDataTableName         HBase vertex data table name                                      * @param vertexDataTableName         HBase vertex data table name                                   
* @param &lt;PVD&gt;                       persistent vertex data type                                 * @param &lt;PVD&gt;                       persistent vertex data type                              
* @throws Exception                                                                                    * @throws Exception                                                                                 
*/                                                                                                     */                                                                                                  
public &lt;PVD extends PersistentVertexData&lt;ED&gt;&gt; void writeVertexData(final EPGMDatabase&lt   public &lt;PVD extends PersistentVertexData&lt;ED&gt;&gt; void writeVertexData(final EPGMDatabase&lt
final Graph&lt;Long, VD, ED&gt; graph = epgmDatabase.getDatabaseGraph().getGellyGraph();             | final LogicalGraph&lt;VD, ED, GD&gt; graph = epgmDatabase.getDatabaseGraph();                       
// group edges by source vertex id (vertex-id, [out-edge-data])                                        // group edges by source vertex id (vertex-id, [out-edge-data])                                     
GroupReduceOperator&lt;Edge&lt;Long, ED&gt;, Tuple2&lt;Long, Set&lt;ED&gt;&gt;&gt; vertexToOutgoingE   GroupReduceOperator&lt;Edge&lt;Long, ED&gt;, Tuple2&lt;Long, Set&lt;ED&gt;&gt;&gt; vertexToOutgoingE
graph.getEdges().groupBy(0).reduceGroup(new GroupReduceFunction&lt;Edge&lt;Long, ED&gt;, Tuple2&lt;L   graph.getEdges().groupBy(0).reduceGroup(new GroupReduceFunction&lt;Edge&lt;Long, ED&gt;, Tuple2&lt;L
                                                                                                                                                                                                           
@Override                                                                                              @Override                                                                                           
public void reduce(Iterable&lt;Edge&lt;Long, ED&gt;&gt; edgeIterable, Collector&lt;Tuple2&lt;Long, S   public void reduce(Iterable&lt;Edge&lt;Long, ED&gt;&gt; edgeIterable, Collector&lt;Tuple2&lt;Long, S
Set&lt;ED&gt; outgoingEdgeData = Sets.newHashSet();                                                    Set&lt;ED&gt; outgoingEdgeData = Sets.newHashSet();                                                 
Long vertexId = null;                                                                                  Long vertexId = null;                                                                               
boolean initialized = false;                                                                           boolean initialized = false;                                                                        
for (Edge&lt;Long, ED&gt; edgeData : edgeIterable) {                                                   for (Edge&lt;Long, ED&gt; edgeData : edgeIterable) {                                                
if (!initialized) {                                                                                    if (!initialized) {                                                                                 
vertexId = edgeData.getSource();                                                                       vertexId = edgeData.getSource();                                                                    
initialized = true;                                                                                    initialized = true;                                                                                 
}                                                                                                      }                                                                                                   
outgoingEdgeData.add(edgeData.getValue());                                                             outgoingEdgeData.add(edgeData.getValue());                                                          
}                                                                                                      }                                                                                                   
collector.collect(new Tuple2&lt;&gt;(vertexId, outgoingEdgeData));                                     collector.collect(new Tuple2&lt;&gt;(vertexId, outgoingEdgeData));                                  
}                                                                                                      }                                                                                                   
});                                                                                                    });                                                                                                 
// group edges by target vertex id (vertex-id, [in-edge-data])                                         // group edges by target vertex id (vertex-id, [in-edge-data])                                      
GroupReduceOperator&lt;Edge&lt;Long, ED&gt;, Tuple2&lt;Long, Set&lt;ED&gt;&gt;&gt; vertexToIncomingE   GroupReduceOperator&lt;Edge&lt;Long, ED&gt;, Tuple2&lt;Long, Set&lt;ED&gt;&gt;&gt; vertexToIncomingE
graph.getEdges().groupBy(1).reduceGroup(new GroupReduceFunction&lt;Edge&lt;Long, ED&gt;, Tuple2&lt;L   graph.getEdges().groupBy(1).reduceGroup(new GroupReduceFunction&lt;Edge&lt;Long, ED&gt;, Tuple2&lt;L
                                                                                                                                                                                                           
@Override                                                                                              @Override                                                                                           
public void reduce(Iterable&lt;Edge&lt;Long, ED&gt;&gt; edgeIterable, Collector&lt;Tuple2&lt;Long, S   public void reduce(Iterable&lt;Edge&lt;Long, ED&gt;&gt; edgeIterable, Collector&lt;Tuple2&lt;Long, S
Set&lt;ED&gt; outgoingEdgeData = Sets.newHashSet();                                                    Set&lt;ED&gt; outgoingEdgeData = Sets.newHashSet();                                                 
Long vertexId = null;                                                                                  Long vertexId = null;                                                                               
boolean initialized = false;                                                                           boolean initialized = false;                                                                        
for (Edge&lt;Long, ED&gt; edgeData : edgeIterable) {                                                   for (Edge&lt;Long, ED&gt; edgeData : edgeIterable) {                                                
if (!initialized) {                                                                                    if (!initialized) {                                                                                 
vertexId = edgeData.getTarget();                                                                       vertexId = edgeData.getTarget();                                                                    
initialized = true;                                                                                    initialized = true;                                                                                 
}                                                                                                      }                                                                                                   
outgoingEdgeData.add(edgeData.getValue());                                                             outgoingEdgeData.add(edgeData.getValue());                                                          
}                                                                                                      }                                                                                                   
collector.collect(new Tuple2&lt;&gt;(vertexId, outgoingEdgeData));                                     collector.collect(new Tuple2&lt;&gt;(vertexId, outgoingEdgeData));                                  
}                                                                                                      }                                                                                                   
});                                                                                                    });                                                                                                 
// co-group (vertex-data) with (vertex-id, [out-edge-data]) to simulate left                           // co-group (vertex-data) with (vertex-id, [out-edge-data]) to simulate left                        
// outer join                                                                                          // outer join                                                                                       
DataSet&lt;Tuple2&lt;Vertex&lt;Long, VD&gt;, Set&lt;ED&gt;&gt;&gt; vertexDataWithOutgoingEdges = gra   DataSet&lt;Tuple2&lt;Vertex&lt;Long, VD&gt;, Set&lt;ED&gt;&gt;&gt; vertexDataWithOutgoingEdges = gra
                                                                                                                                                                                                           
@Override                                                                                              @Override                                                                                           
public void coGroup(Iterable&lt;Vertex&lt;Long, VD&gt;&gt; vertexIterable, Iterable&lt;Tuple2&lt;Lon   public void coGroup(Iterable&lt;Vertex&lt;Long, VD&gt;&gt; vertexIterable, Iterable&lt;Tuple2&lt;Lon
Vertex&lt;Long, VD&gt; vertex = null;                                                                  Vertex&lt;Long, VD&gt; vertex = null;                                                               
Set&lt;ED&gt; outgoingEdgeData = null;                                                                 Set&lt;ED&gt; outgoingEdgeData = null;                                                              
// read vertex data from left group                                                                    // read vertex data from left group                                                                 
for (Vertex&lt;Long, VD&gt; v : vertexIterable) {                                                      for (Vertex&lt;Long, VD&gt; v : vertexIterable) {                                                   
vertex = v;                                                                                            vertex = v;                                                                                         
}                                                                                                      }                                                                                                   
// read outgoing edge from right group (may be empty)                                                  // read outgoing edge from right group (may be empty)                                               
for (Tuple2&lt;Long, Set&lt;ED&gt;&gt; oEdges : outEdgesIterable) {                                    for (Tuple2&lt;Long, Set&lt;ED&gt;&gt; oEdges : outEdgesIterable) {                                 
outgoingEdgeData = oEdges.f1;                                                                          outgoingEdgeData = oEdges.f1;                                                                       
}                                                                                                      }                                                                                                   
collector.collect(new Tuple2&lt;&gt;(vertex, outgoingEdgeData));                                       collector.collect(new Tuple2&lt;&gt;(vertex, outgoingEdgeData));                                    
}                                                                                                      }                                                                                                   
});                                                                                                    });                                                                                                 
// co-group (vertex-data, (vertex-id, [out-edge-data])) with (vertex-id,                               // co-group (vertex-data, (vertex-id, [out-edge-data])) with (vertex-id,                            
// [in-edge-data]) to simulate left outer join                                                         // [in-edge-data]) to simulate left outer join                                                      
DataSet&lt;PersistentVertexData&lt;ED&gt;&gt; persistentVertexDataSet = vertexDataWithOutgoingEdges.   DataSet&lt;PersistentVertexData&lt;ED&gt;&gt; persistentVertexDataSet = vertexDataWithOutgoingEdges.
// write (persistent-vertex-data) to HBase table                                                       // write (persistent-vertex-data) to HBase table                                                    
Job job = Job.getInstance();                                                                           Job job = Job.getInstance();                                                                        
job.getConfiguration().set(TableOutputFormat.OUTPUT_TABLE, vertexDataTableName);                       job.getConfiguration().set(TableOutputFormat.OUTPUT_TABLE, vertexDataTableName);                    
persistentVertexDataSet.map(new HBaseWriter.VertexDataToHBaseMapper&lt;&gt;(vertexDataHandler)).outp   persistentVertexDataSet.map(new HBaseWriter.VertexDataToHBaseMapper&lt;&gt;(vertexDataHandler)).outp
}                                                                                                      }                                                                                                   
