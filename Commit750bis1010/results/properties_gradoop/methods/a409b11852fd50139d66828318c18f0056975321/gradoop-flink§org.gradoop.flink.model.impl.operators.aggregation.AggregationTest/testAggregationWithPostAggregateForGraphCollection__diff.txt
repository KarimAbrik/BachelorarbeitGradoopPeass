/**
 * Test the aggregation with a post-processing step on a graph collection.
 *
 * @throws Exception when the execution in Flink fails.
 */
@Test
public void testAggregationWithPostAggregateForGraphCollection() throws Exception {
    FlinkAsciiGraphLoader loader = getLoaderFromString("input1 [" + "(i1 {a: 1L}) (i2 {a: 2L})" + "] input2 [" + "(i3 {a: -1L}) (i4 {a: 3L})" + "] input3 [] expected1 {sum_a: 3L, sum_a_plusone: 4L} [" + "(i1)(i2)" + "] expected2 {sum_a: 2L, sum_a_plusone: 3L} [" + "(i3)(i4)" + "] expected3 {sum_a: NULL, sum_a_plusone: NULL} []");
    GraphCollection input = loader.getGraphCollectionByVariables("input1", "input2", "input3");
    GraphCollection expected = loader.getGraphCollectionByVariables("expected1", "expected2", "expected3");
    GraphCollection result = input.apply(new ApplyAggregation<>(new SumVertexProperty("a", "sum_a"), new SumPlusOne("a", "sum_a_plusone")));
    collectAndAssertTrue(expected.equalsByGraphData(result));
}